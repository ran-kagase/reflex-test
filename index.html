<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>反射神経測定 Pro (Final Edition)</title>
    <style>
        body {
            margin: 0; padding: 0; background-color: #f0f0f0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #game-container { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; position: relative; }
        
        #fixation-point { font-size: 60px; color: #333; display: none; z-index: 1; }
        #target { width: 65px; height: 65px; position: absolute; display: none; cursor: pointer; z-index: 2; }
        
        .shape-circle { border-radius: 50%; }
        .shape-square { border-radius: 8px; }
        .shape-diamond { transform: rotate(45deg); }

        #start-preview {
            position: absolute; display: none; text-align: center; z-index: 50;
        }
        #preview-target {
            width: 100px; height: 100px; margin: 0 auto 20px auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.15);
        }

        #miss-notification {
            position: absolute; top: 25%; width: 100%; text-align: center;
            font-size: clamp(60px, 10vw, 100px); font-weight: bold; color: #ff0000;
            display: none; z-index: 20; text-shadow: 3px 3px 15px rgba(0,0,0,0.3); pointer-events: none;
        }
        
        #stats-ui {
            position: absolute; top: 30px; left: 30px; background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px); padding: 25px; border-radius: 12px;
            font-size: 18px; display: none; min-width: 200px; z-index: 10;
        }
        #stats-ui span { font-weight: bold; color: #007bff; }

        #instruction {
            position: absolute; bottom: 50px; width: 100%; text-align: center;
            color: #444; display: none; font-size: clamp(18px, 4vw, 24px); font-weight: bold; z-index: 10;
        }

        #overlay {
            position: absolute; z-index: 100; text-align: center; background: rgba(255, 255, 255, 0.95);
            padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 500px; width: 90%;
        }

        .mode-section { text-align: left; margin: 15px 0; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .mode-section h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .radio-group { display: flex; gap: 15px; }
        .radio-group label { cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; font-size: 14px; }

        #regulations-area { display: none; text-align: left; background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 10px; line-height: 1.8; font-size: 14px; }
        #regulations-area ul { padding-left: 20px; margin: 10px 0; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; transition: 0.2s; }
        .primary-btn { background-color: #28a745; color: white; }
        .secondary-btn { background-color: #6c757d; color: white; }
        
        .result-list { text-align: left; margin: 20px 0; font-size: 18px; border-top: 1px solid #ddd; padding-top: 15px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="miss-notification">ミス！</div>
    
    <div id="start-preview">
        <div id="preview-target"></div>
        <div id="preview-text" style="font-size: 24px; font-weight: bold;">準備...</div>
    </div>

    <div id="stats-ui">
        <div>セット: <span id="current-set">0</span> / 5</div>
        <div>最新: <span id="last-time">-</span> ms</div>
        <div>平均: <span id="avg-time">-</span> ms</div>
    </div>

    <div id="fixation-point">＋</div>
    <div id="target"></div>
    <div id="instruction"></div>

    <div id="overlay">
        <h1 id="title">反射神経テスト Pro</h1>
        
        <div id="menu-content">
            <div id="main-menu-options">
                <div class="mode-section">
                    <h3>1. 視野モード</h3>
                    <div class="radio-group">
                        <label><input type="radio" name="vision" value="peripheral" checked> 周辺視野</label>
                        <label><input type="radio" name="vision" value="central"> 中心視野</label>
                    </div>
                </div>
                <div class="mode-section">
                    <h3>2. ターゲット設定</h3>
                    <div class="radio-group">
                        <label><input type="radio" name="colorMode" value="multi" checked> 3色混合</label>
                        <label><input type="radio" name="colorMode" value="single"> 単色固定</label>
                    </div>
                </div>
            </div>

            <div id="regulations-area">
                <strong>【レギュレーション】</strong>
                <ul>
                    <li>指定されたターゲットのみクリックしてください</li>
                    <li>色は「赤・青・緑」が登場します</li>
                    <li>ターゲットの形状は毎ゲーム変わります</li>
                    <li>はずれターゲットの出現確率は、出るたびに減少します</li>
                    <li><b>ミスをした場合、その時点でゲーム終了となり結果が表示されます</b></li>
                </ul>
            </div>

            <div class="btn-group">
                <button id="start-btn" class="primary-btn">スタート</button>
                <button id="reg-btn" class="secondary-btn">詳細 / レギュレーション</button>
            </div>
        </div>

        <div id="result-content" style="display:none;">
            <div id="result-area"></div>
            <div class="btn-group">
                <button id="retry-btn" class="primary-btn">もう一度！</button>
                <button id="back-to-menu-btn" class="secondary-btn">メニューに戻る</button>
            </div>
        </div>
    </div>
</div>

<script>
    const TOTAL_SETS = 5;
    const MAX_FALSE_LIMIT = 8;
    const COLORS = [
        { name: '赤', code: '#ff4d4d' },
        { name: '青', code: '#4d79ff' },
        { name: '緑', code: '#28a745' }
    ];
    const SHAPES = ['shape-circle', 'shape-square', 'shape-diamond'];

    let results = [];
    let setCounter = 0;
    let falseColorCount = 0;
    let targetActive = false;
    let gameActive = false;
    let timeoutId = null;
    let startTime;
    let targetColor, targetShapeClass, visionMode, colorMode;

    const el = {
        target: document.getElementById('target'),
        instruction: document.getElementById('instruction'),
        overlay: document.getElementById('overlay'),
        menuContent: document.getElementById('menu-content'),
        resultContent: document.getElementById('result-content'),
        statsUi: document.getElementById('stats-ui'),
        fixation: document.getElementById('fixation-point'),
        resultArea: document.getElementById('result-area'),
        miss: document.getElementById('miss-notification'),
        startPreview: document.getElementById('start-preview'),
        previewTarget: document.getElementById('preview-target'),
        previewText: document.getElementById('preview-text'),
        startBtn: document.getElementById('start-btn'),
        regBtn: document.getElementById('reg-btn'),
        regArea: document.getElementById('regulations-area'),
        menuOptions: document.getElementById('main-menu-options'),
        title: document.getElementById('title')
    };

    el.startBtn.addEventListener('click', prepareGame);
    document.getElementById('retry-btn').addEventListener('click', prepareGame);
    el.regBtn.addEventListener('click', toggleReg);
    document.getElementById('back-to-menu-btn').addEventListener('click', showMenu);

    function toggleReg() {
        const isOpening = el.regArea.style.display !== 'block';
        el.regArea.style.display = isOpening ? 'block' : 'none';
        el.menuOptions.style.display = isOpening ? 'none' : 'block';
        el.startBtn.style.display = isOpening ? 'none' : 'block';
        el.regBtn.textContent = isOpening ? '戻る' : '詳細 / レギュレーション';
    }

    function showMenu() {
        // UI基本表示のリセット
        el.overlay.style.display = 'block';
        el.menuContent.style.display = 'block';
        el.resultContent.style.display = 'none';
        el.statsUi.style.display = 'none';
        el.fixation.style.display = 'none';
        el.instruction.style.display = 'none';
        el.startPreview.style.display = 'none';

        // メニュー内状態のリセット
        el.regArea.style.display = 'none';
        el.menuOptions.style.display = 'block';
        el.startBtn.style.display = 'block';
        el.regBtn.textContent = '詳細 / レギュレーション';
        el.title.textContent = '反射神経テスト Pro';
    }

    function prepareGame() {
        visionMode = document.querySelector('input[name="vision"]:checked').value;
        colorMode = document.querySelector('input[name="colorMode"]:checked').value;
        results = []; setCounter = 0;

        targetColor = COLORS[Math.floor(Math.random() * COLORS.length)];
        targetShapeClass = SHAPES[Math.floor(Math.random() * SHAPES.length)];

        el.overlay.style.display = 'none';
        
        el.previewTarget.className = targetShapeClass;
        el.previewTarget.style.backgroundColor = targetColor.code;
        el.previewText.innerHTML = colorMode === 'multi' ? 
            `<span style="color:${targetColor.code}">${targetColor.name}</span> を狙え！` : "スタート！";
        el.startPreview.style.display = 'block';

        setTimeout(() => {
            el.startPreview.style.display = 'none';
            startGame();
        }, 1000);
    }

    function startGame() {
        el.fixation.style.display = 'block';
        el.statsUi.style.display = 'block';
        el.instruction.innerHTML = colorMode === 'multi' ? 
            `<span style="color:${targetColor.code}">■</span> ${targetColor.name} をクリックしてください` :
            `出現したらクリックしてください`;
        el.instruction.style.display = 'block';
        updateStats();
        startNewSet();
    }

    function startNewSet() {
        if (setCounter >= TOTAL_SETS) { endGame(); return; }
        gameActive = true; falseColorCount = 0;
        const waitTime = Math.floor(Math.random() * 21 + 10) * 100;
        timeoutId = setTimeout(pickAndShowTarget, waitTime);
    }

    function pickAndShowTarget() {
        el.target.style.display = 'none';
        targetActive = false;

        let isCorrectColor = true;
        if (colorMode === 'multi') {
            let blueChance = 0.8 * (1 - Math.pow(falseColorCount / MAX_FALSE_LIMIT, 1.5));
            if (falseColorCount >= MAX_FALSE_LIMIT) blueChance = 0;
            isCorrectColor = Math.random() > blueChance;
        }

        let currentColor = isCorrectColor ? targetColor : 
            COLORS.filter(c => c.name !== targetColor.name)[Math.floor(Math.random() * 2)];

        el.target.className = targetShapeClass;
        el.target.style.backgroundColor = currentColor.code;
        el.target.dataset.type = isCorrectColor ? 'go' : 'nogo';

        const pos = visionMode === 'central' ? 
            { x: window.innerWidth/2 - 32, y: window.innerHeight/2 - 32 } : 
            getRandomPosition();
        
        el.target.style.left = `${pos.x}px`;
        el.target.style.top = `${pos.y}px`;
        el.target.style.display = 'block';

        targetActive = true;
        startTime = performance.now();

        if (isCorrectColor) {
            timeoutId = setTimeout(() => { if (targetActive) triggerMiss("タイムアウト"); }, 1500);
        } else {
            const duration = Math.floor(Math.random() * 5 + 6) * 100;
            timeoutId = setTimeout(() => {
                el.target.style.display = 'none'; targetActive = false; falseColorCount++;
                const nextWait = Math.floor(Math.random() * 5 + 8) * 100;
                timeoutId = setTimeout(pickAndShowTarget, nextWait);
            }, duration);
        }
    }

    function handleInput() {
        if (targetActive && el.target.dataset.type === 'go') {
            recordResult(Math.round(performance.now() - startTime));
        } else {
            triggerMiss(targetActive ? "お手つき" : "フライング");
        }
    }

    function triggerMiss(reason) {
        clearTimeout(timeoutId);
        gameActive = false; targetActive = false;
        el.target.style.display = 'none';
        el.miss.style.display = 'block';
        el.miss.textContent = (reason === "フライング") ? "フライング！" : "ミス！";
        setTimeout(() => {
            el.miss.style.display = 'none';
            endGame(true);
        }, 800);
    }

    function recordResult(time) {
        clearTimeout(timeoutId);
        gameActive = false; targetActive = false;
        el.target.style.display = 'none';
        results.push(time); setCounter++;
        updateStats();
        if (setCounter < TOTAL_SETS) setTimeout(startNewSet, 400);
        else endGame();
    }

    function updateStats() {
        document.getElementById('current-set').textContent = setCounter;
        if (results.length > 0) {
            document.getElementById('last-time').textContent = results[results.length - 1];
            document.getElementById('avg-time').textContent = Math.round(results.reduce((a, b) => a + b) / results.length);
        }
    }

    function getRandomPosition() {
        const margin = 100;
        let x, y, dist;
        do {
            x = Math.random() * (window.innerWidth - margin * 2) + margin;
            y = Math.random() * (window.innerHeight - margin * 2) + margin;
            dist = Math.hypot(x - window.innerWidth/2, y - window.innerHeight/2);
        } while (dist < 180);
        return { x: x - 32, y: y - 32 };
    }

    function endGame(isMiss = false) {
        gameActive = false;
        el.statsUi.style.display = 'none'; el.fixation.style.display = 'none'; el.instruction.style.display = 'none';
        el.overlay.style.display = 'block'; el.menuContent.style.display = 'none'; el.resultContent.style.display = 'block';
        const avg = results.length > 0 ? Math.round(results.reduce((a, b) => a + b) / results.length) : 0;
        el.title.textContent = isMiss ? "ゲームオーバー" : "リザルト";
        el.resultArea.innerHTML = `
            <div class="result-list">
                <div style="margin-bottom:10px; color:#666; font-size:14px;">
                    設定: ${visionMode === 'central' ? '中心' : '周辺'} / ${colorMode === 'multi' ? '3色' : '単色'}
                </div>
                ${results.map((r, i) => `<div>セット ${i+1}: <b>${r} ms</b></div>`).join('')}
                ${isMiss ? `<div style="color:red; font-weight:bold; margin-top:5px;">※ミスにより中断 (${results.length}/${TOTAL_SETS} 達成)</div>` : ''}
                <hr>
                <div style="font-size:22px;">平均反応速度: <strong>${avg || '-'} ms</strong></div>
            </div>`;
    }

    const handleAllInputs = (e) => { if(gameActive) { if(e.type === 'touchstart') e.preventDefault(); handleInput(); } };
    window.addEventListener('mousedown', (e) => e.button === 0 && handleAllInputs(e));
    window.addEventListener('keydown', (e) => !e.repeat && handleAllInputs(e));
    window.addEventListener('touchstart', handleAllInputs, {passive: false});
</script>
</body>
</html>